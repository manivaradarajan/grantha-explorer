import unittest
import os
import shutil
import yaml
import re
import sys

from scripts.convert_vishvas_brh import convert_file, parse_source_file, process_body, generate_target_frontmatter, num_to_devanagari
from tools.grantha_converter.hasher import hash_text, normalize_text


class TestVishvasBrhConverter(unittest.TestCase):
    def setUp(self):
        self.test_input_dir = "test_data/vishvas-brh_input"
        self.test_output_dir = "test_data/vishvas-brh_output"
        self.original_input_dir = "granthas/vishvas-brh"
        self.original_output_dir = "granthas/output_vishvas_brh_structured"

        # Create dummy input files for testing
        os.makedirs(self.test_input_dir, exist_ok=True)
        os.makedirs(self.test_output_dir, exist_ok=True)

        # Sample content for 03-01.md
        self.sample_03_01_content = """+++ 
title = "०३-०१"

+++ 
**॥ श्रीः ॥  बृहदारण्यकोपनिषत्  (शुक्लयजुर्वेदकाण्वशाखान्तर्गता) [उपक्रमशान्तिपाठः] हरिः ओम् पूर्णमदः पूर्णमिदं पूर्णात् पूर्णमुदच्यते । पूर्णस्य पूर्णमादाय पूर्णमेवावशिष्यते ॥ ॥ ओं शान्तिः शान्तिः शान्तिः ॥** 

शुक्लयजुर्वेदीयानां एषः शान्तिपाठमन्त्रः । परब्रह्मणः समग्रस्वरूपस्वभावप्रतिपादकः इति यथासिद्धान्तं विपुलविशदं विवरणं अर्हति । तथा हि - पूरी आप्यायने (धा.पा.१८०४) इत्यस्मात् चौरादिकत्वेन स्वार्थणिजन्तात् धातोः क्तप्रत्यये सति वा दान्त-शान्त-पूर्ण- दस्त-स्पष्ट-छन्न-ज्ञप्ताः (पा.सू.७-२-२७) इति पाणिनि सूत्रेण पूर्णशब्दोऽयं निपात्यते । इडागमाभावः निपातस्य फलम् । णिलोपः, रात् परत्वात् प्रत्ययतकारस्य नत्वं, तस्य णत्वं चेति पूर्णशब्दसिद्धौ प्रक्रिया । क्तप्रत्ययश्च इह कर्तरि कर्मणि वेति उभयथापि भाव्यम् । तत्र कर्तरि - ब्रह्मस्वरूपेण पूरयति - व्याप्नोति इत्यर्थः । कर्मणि तु ब्रह्म कल्याणगुणैः सम्भृतमित्यर्थः । असङ्कुचितवृत्तिनानेन पूर्णशब्देन सर्वत्र सर्वदा सर्वथा च पूर्णत्वं ब्रह्मणः प्रतिपाद्यते । तद्यथा - सर्वत्रेति सर्वदेशव्याप्तिविवक्षा । सर्वत्र पूर्णता नाम सर्वव्याप्तस्य तत्तद्देशावच्छेदेनापि परिसमाप्यवृत्तित्वपर्यवसानम् । तद्वा कथम्? न हि एकत्र पूर्णतया स्थितस्य अन्यत्र वृत्तिसम्भवः, इति शङ्का निरस्यते सिद्धान्तिभिः विशिष्टाद्वैतिभिः व्यक्तिषु परिसमाप्तामपि व्यापिनीं तार्किकाणां जाति निदर्शयद्भिरिति भाव्यम् । सर्वदा-इति कालानवच्छेदेन व्याप्तिविवक्षा । सर्वथा-इति व्याप्तिप्रकारविवक्षा च । तत्र स्वरूपतः गुणतश्चेति व्याप्तिप्रकारद्वैविध्यम् । तेन दीपादुत्पन्नप्रदीपन्यायेन परस्वरूपवत् उत्तरेषां 'व्यूह-विभव-अन्तर्यामि-अर्चावताराणां अपि गुणैः पूर्णतासिद्धिः । एतदभिप्रायेणैव मन्त्रपदानि व्याख्येयानि । तथा हि - पूर्णमदः पूर्णमिदं इति पूर्णमिदं पूर्णमदः इति च पाठभेदः दृश्यते । तत्र विप्रकृष्टवाचिना अदश्शब्देन नित्यविभूतिवर्तिपरस्वरूपग्रहणम् । सन्निहितवाचिना इदंशब्देन च हृदयगुहावतिं अन्तर्यामिरूपं विवक्षितम् । **पूर्णशब्दः** 

गुणपौष्कल्यवचनः । तथा च - परवासुदेवमूर्तिरिव अन्तर्यामिस्वरूपं च षाड्गुण्यपुष्कलमिति प्रथमवाक्यार्थः । अथ, **पूर्णात्** - पूर्वोक्तपरवासुदेवसकाशात् आविर्भूतं **पूर्णं** - व्यूहस्वरूपं, **उदच्यते** - बहुप्रकारं भवति । सङ्कर्षण-प्रद्युम्न-अनिरुद्ध-रूपेण द्वि-द्वि-गुणाविष्करणशालि सत् त्रिप्रकारं भवतीति भावः । तत्र व्यूहत्रये प्रतिव्यक्ति गुणद्वयमात्राविष्करणेऽपि स्वतः गुणषट्कमेव इति न न्यूनता भाव्या । इदं चोक्तं पाञ्चरात्रानुसारतः श्रीवत्सचिह्नगुरुभिः वरदराजस्तवे- ***गुणैष्षभिस्त्वेतैः प्रथमतरमूर्तिस्तव बभौ । ततस्तिस्रः तेषां त्रियुगयुगळैर्हि त्रिभिरभूत् ॥ (**  १६**  ) इत्यादिना ।* पूर्णस्य पूर्णं** - इह षष्ठ्यन्तपूर्णशब्दः सर्वावतारकन्दभूतं क्षीराब्धिशायि व्यूहरूपं वदति । तत्सम्बन्धि पूर्ण रामकृष्णादि विभवावतारजातम् । तत् (द्वितीयान्तम्) **आदाय** 

स्वहेतुत्वेन स्वीकृत्य, **पूर्णमेवावशिष्यते** - अर्चावताररूपमेव चरमतया वर्तते सर्वसमाश्रयणोपयोगि नित्यसन्निहितं कल्याणगुणपूर्ण च, इति मन्त्रस्य पदार्थविवरणम् । एतेन परब्रह्मणः सर्वव्याप्तिः सर्वत्र गुणपौष्कल्यं च प्रतिपादितं भवति । अध्ययनारम्भे एवंविधपरिपूर्ण-ब्रह्मस्वरूपध्यानं शान्तिमन्त्रेणानेन विधित्सितमिति बोध्यम् । श्रीवचनभूषणस्य अरुम्बदाख्ये द्रविडभाषामयटिप्पणे समञ्जसमिदं विवरणं दृश्यम् । यद्यपि श्रीरङ्गरामानुजमुनीन्द्रः बृहदारण्यके (७-१) अयं मन्त्रः प्रकरणात् प्रणवस्तुति- परतया व्याख्यातः । तदेवम् - पूर्णमदः पूर्णमिदं इत्यनेन परोक्षप्रत्यक्षसर्वलोकानां
वेदशब्दप्रभवत्वात् तद्व्याप्तत्वं प्रोच्य, (कारणेन कार्यस्य व्याप्तत्वात् कारणीभूतवेदशब्दव्याप्तता लोकानां इति) । एवं पूर्णात् (व्याप्तात् लोकात्) पूर्ण पूरणकर्तृव्याहृतिरूपभूर्भुवरादि शब्दजातम् **उदच्यते** - उत्कृष्टं भवति इति च व्याख्याय, **पूर्णस्य पूर्णं** - व्याप्तलोकस्य पूरकं व्याहृतिरूपशब्दजातम्, **आदाय** - उपसंहृत्य, **पूर्णं** - तस्यापि व्यापकं ओङ्काररूपं वस्तु, **अवशिष्यते** - कार्यसर्वशब्दजाते नष्टेऽपि परिशिष्यते इति विवरणं कृतम् । अथ तैरेव अन्ते इदं च रुच्युत्पादनाय प्रणवस्तुतिमात्रम् । अन्यथा निमित्तकारणस्य व्याहत्यादेः कार्यव्यापकत्वासम्भवात् । उपादानभूतस्य भूतपञ्चकस्यैव व्यापकत्वसम्भवात् असामञ्जस्यं स्यात् इति समापितम् । तथापि एवं स्वेनैव रुच्युत्पादनाय प्रणवस्तुतिपरत्वोक्त्या अवास्तवमेवेदं प्रणवस्तुतिपरत्वमिति व्यञ्जनात्, युक्तं प्रणवप्रतिपाद्यस्य ब्रह्मण एव परत्वादिपञ्चकपरतया व्याख्यानमिति प्रतीमः । वस्तुतः इदं श्रीरङ्गरामानुजीयं विवरणं वाक्यान्वयाधिकरणगतश्रुतप्रकाशिका वचनविरुद्धमपि । तत्र हि व्यासार्यैः यादवप्रकाश- पक्षनिराससन्दर्भ परमात्मपरतयैव मन्त्रोऽयं विवृतः । तत्रेयं तदीयसूक्तिः परमात्मनः पूर्णत्वं च अणुमात्रेऽपि वस्तुनि स्थितस्य निरवधिकषाड्गुण्यविशिष्टतया प्रतिपत्तियोग्यत्वम् इति ॥ ॥ इति शान्तिपाठविवरणम् ॥ ***

[1. **व्यूहः** - पर एवोपासनार्थं जगत्सृष्ट्याह्यर्थञ्च वासुदेव - सङ्कर्षण - प्रद्युम्न -अनिरुद्ध भेदेन चतुर्धाऽवस्थितः । **विभवः** - तत्तत्सजातीयरूपेणाविर्भावः । **अन्तर्यामि** - स्वर्गनरकाद्यनुभवदशायामपि जीवात्मनः योगिभिः द्रष्टव्यतया हृदयप्रदेशावस्थितरूपम् । **अर्चावतारः** - देशकालविप्रकर्षरहितः आश्रिताभिमतद्रव्यादिकं शरीरतया स्वीकृत्य तस्मिन्नप्राकृतशरीरविशिष्टस्सन् अर्चकपराधीन-स्रानभोज्या- सनशयनसनस्थितिः सर्वसहिष्णुः परिपूर्णो गृहग्रामनगरप्रशस्तदेशशैलादिषु वर्तमानो मूर्तिविशेषः ।] **बृ ह दा र ण्य को प नि ष त् तृतीयोऽध्यायः प्रथमं ब्राह्मणम् अश्वब्राह्मणम् [अश्वमेधीयाश्वस्य अङ्गेषु उषा आदि दृष्टिः]  हरिः ओम् । उषा वा अश्वस्य मध्यस्य शिरः । सूर्यश्चक्षुर्वातः प्राणो व्यात्तमग्निर्वैश्वानरः संवत्सर आत्माऽश्वस्य मेध्यस्य । द्यौः पृष्ठमन्तरिक्षमुदरं पृथिवी पाजस्यं दिशः पार्श्वे अवान्तरदिशः पर्शवः, ऋतवोऽङ्गानि मासाश्चार्द्धमासाश्च च पर्वाण्यहोरात्राणि प्रतिष्ठा नक्षत्राण्यस्थीनि, नभो माँसानि । उवध्यँ सिकताः सिन्धवो गुदा यकृञ्च क्लोमानश्च पर्वता ओषधयश्च वनस्पतयश्च लोमानि । उद्यन् पूर्वार्धो निम्लोचन् जघनार्धो यद्विजृम्भते तद्विद्योतते यद्विधूनुते तत् स्तनयति, यन्मेहति तद्वर्षति, वागेवास्य वाक् ॥ प्रकाशिका रङ्गरामानुजमुनिविरचिता  [मङ्गलाचरणम्] अतसीगुच्छसच्छायमञ्चितोरस्थलं श्रिया । अञ्जनाचलशृङ्गारमञ्जलिर्मम गाहताम् ॥  [आचार्यवन्दनम्] व्यासं लक्ष्मणयोगीन्द्रं प्रणम्यान्यान् गुरूनपि । बृहदारण्यकव्याख्यां करोमि विदुषां मुदे ॥  [अवतारिका]** 

अष्टाध्यायात्मके बृहदारण्यके प्रवर्योपसत्प्रतिपादक प्रथमद्वितीयाध्यायौ उपेक्ष्योत्तरोऽध्यायगणो व्याख्यायते । यद्यपि **उषा वा अश्वस्य** इत्यादिकमपि अश्वमेधादि- कर्मविषयकमेव, तथापि ब्रह्मदृष्टिः विधिरूपतया ब्रह्मात्मकत्व प्रतिपादनपरतया' यथाकथञ्चित् ब्रह्मसम्बन्धित्वेन तद्व्याख्यानस्योचितत्वात् । अत एवाश्वमेधब्राह्मणादेब्रह्मपरोपनिषद्भाग- सङ्गतिरुपपद्यते। न च प्रवर्ग्योपसत्पराध्यायद्विकस्य ब्रह्मपर आरण्यकमध्ये विद्यासन्निधौ पाठाद्विद्यार्थत्वं शङ्क्यम्; वेधाद्यर्थभेदात् (ब्र.सू.३-३-२५) इति अधिकरणे शुक्रं प्रविध्य हृदयं प्रविध्य (अथर्व.उ.१) तेजस्वि नावधीतमस्तु (तै.आन.१) इत्यादीनां शत्रुहृदय- वेधाध्ययनादि प्रकाशकानां मन्त्राणां, देवा ह वै सत्रं निषेदुः (शत.ब्रा.१४-१-१) इति बृहदारण्यक आरम्भपठितब्राह्मणप्रतिपादितप्रवर्ग्यादेः च कर्मणः, लिङ्गादिबलेन अन्यत्र विनियुक्तत्वेऽपि विद्यासन्निधिपाठाऽऽनर्थक्यपरिहाराय विद्यार्थत्वं इति पूर्वपक्षे, विद्यासन्निधिपाठस्य दिवाकीर्त्यत्वारण्यपाठ्यत्वादिसौकर्यार्थतया अपि उपपत्तेः बलवद्भिः लिङ्गादिभिः अभिचाराध्ययनज्योतिष्टोमादि अर्थत्वं इति वेधाद्यर्थभेदात् (ब्र.सू.३-३-२५) इति सूत्रेण सिद्धान्तितत्वात् । तस्य च सूत्रस्य अयं अर्थः - 'मन्त्रप्रतिपाद्यस्य वेधाद्यर्थस्य विद्यार्थत्वाभावेन विद्यार्थात् भेदात् तत्प्रकाशनद्वारा विद्याशेषत्वमपि इत्यभिचारादिशेषत्वम्' इति । ततः च न विद्यार्थत्वशङ्कायाः अवकाशः । सर्वकर्मश्रेष्ठ अश्वमेधाङ्गभूते अश्वे-यदेव विद्यया करोति श्रद्धयोपनिषदा तदेव वीर्यवत्तरं भवति (छां.उ.१-१-१०) इति कर्मवीर्यवत्तरत्वापादिका विश्वरूपत्व उपासना उपदिश्यते- **उषा वा अश्वस्य मध्यस्य शिरः । मेघः।** - यज्ञः, तं अर्हति इति **मेध्यः** । यज्ञार्थस्य पशोः यत् शिरः तत् उषा : – ब्राह्मः मुहूर्तः । लिङ्गव्यत्ययः छान्दसः । उषःः अहर्मुखत्वेन अहश्शिरस्त्वात् पशोः शिरसि तद्बुद्धिः उपपद्यते इति द्रष्टव्यम् । आदित्यादिमतयश्च अङ्गे उपपत्तेः (ब्र.सू.४-१-६) इति अधिकरणे य एव असौ तपति तं उद्गीथं उपासीत (छां.उ.१-३-१) इत्यत्र कर्माङ्गभूते उद्गीथे आदित्यदृष्टिः कर्तव्या, उत आदित्ये उद्गीथदृष्टिः इति विशये, ब्रह्मदृष्टिरुत्कर्षात् (ब्र.सू.४-१-५) इति सूत्रोक्तन्यायेन उत्कृष्टदृष्टेः एव अपकृष्टे कर्तव्यत्वात् कर्माङ्गस्य उद्गीथस्य कर्मोपकारकत्वेन उत्कृष्टतया तद्बुद्धिः एव आदित्ये कर्तव्या इति पूर्वपक्षे प्राप्ते-आदित्यादिमतयश्च अङ्गे उपपत्तेः (ब्र.सू.४-१-६) इति सूत्रेण सिद्धान्तितम् । अत्र च शब्दः अवधारणे । अङ्ग एव आदित्यादिमतयः कार्याः, कर्माराध्यतया आदित्यादीनां एव उत्कृष्टत्वस्य उपपत्तेः इति तदर्थः । ततः च अश्वस्य शिरःप्रभृति अवयवेषु कर्माङ्गभूतेषु एव उष आदि बुद्धिः, कार्या, न तु उष आदौ शिर आदिबुद्धिः । सूर्यश्चक्षुः - अश्वस्य चक्षुस्सूर्यः । सूर्याधिष्ठातृकत्वात् तद्बुद्धिस्तत्र कार्येत्यर्थः । वातः प्राणः अश्वस्य प्राण एव वातः । वाय्ववस्थाविशेषत्वात्प्राणस्य तद्बुद्धिस्तत्र कार्येत्यर्थः । व्यात्तमग्निः वैश्वानरः विवृतं मुखमेव वैश्वानरोऽग्निः । अग्निर्वाग्भूत्वा मुखं प्राविशत् (ऐत.उ.१-२-४) इति अग्नेर्मुखाधिष्ठा-तृत्वात् तद्बुद्धिस्तत्र कार्येत्यर्थः । संवत्सरः इति – संवत्सरः अश्वस्य मध्यस्य आत्मा स्वरूपमित्यर्थः । ऋतवोऽङ्गानि इत्यादिना संवत्सरावयव ऋतुमासादीनां तदवयवत्वेन निरूपयिष्यमाणत्वात् संवत्सरस्यावयविशरीरात्मकत्वम् । अश्वस्य मध्यस्य इति सर्वत्रानुषङ्गार्थं पुनर्वचनम् । संवत्सर शब्देन संवत्सराभिमानी प्रजापतिर्वा विवक्षितः । द्यौः पृष्ठम् – ऊर्ध्वत्वसामान्यात् । अन्तरिक्षमुदरम् – अवकाशत्वसाम्यात् । पृथिवी पाजस्यम् । भुजान्तरामित्यर्थः । द्यौः पृष्ठमन्तरिक्षमुदरमियमुर (बृ.उ.१-२-३) इत्यग्नेरुरसि पृथिवीदृष्टि-दर्शनात् । दिशः पार्श्वे – दिशः दक्षिणोत्तरत्वाद्याश्रयत्वात्पार्श्वे । अवान्तरदिशः पर्शवः वायव्याद्या अवान्तरदिशः पार्श्वास्थीनी । ऋतवोऽङ्गानि – स्पष्टोऽर्थः । मासाश्चार्धमासाश्च पर्वाणि इति । पर्वाणि अङ्गसन्धयः । समविभागसाम्यात् । अहोरात्राणि प्रतिष्ठा – पादा इत्यर्थः । नक्षत्राण्यस्थीनि – शुक्लत्वसाम्यात् । नभो मांसानि अस्थ्यात्मकनक्षत्रसंपृक्तत्वात् । उवध्यँ सिकताः अर्धजीर्णं घासाद्यशनं सिकताः । विश्लिष्टावयवसाम्यात् । सिन्धवो गुदाः । गुदा इति अवयवाभिप्रायेण बहुवचननिर्देशः । सिन्धवः – नद्य इत्यर्थः । यकृच्च क्लोमानश्च पर्वताः हृदयस्याधःप्रदेशवर्तिदक्षिणोत्तरमांसखण्डौ यकृत्क्लोमशब्दवाच्यौ । क्लोमानः – इति एकस्मिन् व्यत्ययाद्बहुवचनम् । पर्वताः – काठिन्योन्नतत्वपिण्डाकारत्वसाम्यात् । ओषधयश्च वनस्पतयश्च लोमानि – सूक्ष्मत्वसाम्यात् । उद्यन् पूर्वार्धः सूर्य इति शेषः । उद्यन् सूर्यः शरीरपूर्वार्ध इत्यर्थः । निम्लोचन् जघनार्धः । निम्लोचन् – अस्तं गच्छन् सूर्यः अपरार्धः, पूर्वापरत्व-साम्यात् । यद्विजृम्भते तद्विद्योतते – मुखव्यादानमेवान्तरप्रकाशहेतुत्वात् विद्युत् । यद्विधूनुते तत्स्तनयति – रोमविधूननमेव सशब्दत्वात् मेघनिर्घोषः । यन्मेहति तद्वर्षति मूत्रोत्सर्जनमेव सेचनत्वसाम्यावर्षणम् । वागेवास्य वाक् – नात्र कल्पनापेक्षा ॥ १ ॥ 

**[अश्चानुबन्धिषु दृष्टिः]  अहर्वा अश्वमिति** - अश्वस्याग्रतः पृष्ठतश्च सौवर्णराजतौ महिमाख्यौ ग्रहौ पात्रविशेषौ स्तः । तयोर्मध्ये **अश्वं पुरस्तात्-** अश्वस्य पुरस्तात् यो **महिमा** 

महिमाख्यो ग्रहविशेषः । सः अहरेव **अन्वजायत** -समपद्यत । तत्राहर्भावना कर्तव्येति यावत् । अह्न इव सौवर्णपात्रस्यापि पीतप्रभत्वात् । **तस्य पूर्वे समुद्रे योनिः** - पूर्वः समुद्रो **योनिः** - आसादनस्थानम् । सौवर्णपात्रग्रहासादनस्थाने पूर्वसमुद्रबुद्धिः कार्येत्यर्थः । यद्वा - **महिमान्वजायत** इत्यत्रानुर्लक्षणार्थः । कर्मप्रवचनीयत्वात्तद्योगे अश्वमिति द्वितीया । **रात्रिरेनम्** इति । **एनम्** - अस्य अश्वस्य पश्चाद्यो राजतो महिमाख्यो ग्रहविशेषः । सः **रात्रिरन्वजायत** - रात्रिस्समपद्यतेत्यर्थः । चन्द्रिकाधवलत्वसाम्यात् । **तस्यापरे समुद्रे योनिः** - पश्चिमस्समुद्रः तदासादनस्थानमित्यर्थः । **एतौ वा** इति - एतौ वै महिमाख्यौ ग्रहौ अश्वस्य पूर्वोत्तरपार्श्वयोः प्रतिष्ठितावित्यर्थः । अतः सर्वतो महिमशाल्यश्व इति स्तुत्वा हयवाज्यर्वाश्वरूपैश्चितुर्भिर्जातिविशेषैर्देवगन्धर्वासुरमनुष्यवोढृत्वेनाश्वं स्तौति - **हयो भूत्वा देवानवहत्** इत्यादिना । **समुद्र एवास्य बन्धुः** इति । **अस्य** अश्वस्य समुद्रो बन्धुः । तत्र बन्धुदृष्टिः कर्तव्येत्यर्थः । तत्र हेतुमाह - **समुद्रो योनिः** इति - उच्चैश्श्रवसोऽश्वस्य वारुणाश्वानां च तस्मादुत्पत्तिदर्शनात् समुद्रो योनित्वेन ध्यातव्य इत्यर्थः ॥ २ ॥ **॥ इति तृतीयाध्याये प्रथमं ब्राह्मणं प्रकाशिका ॥ तृतीयाध्याये द्वितीयं ब्राह्मणम्  अश्वमेधब्राह्मणम्  [अश्वमेधादौ दृष्टिविधानाय मृत्युकर्तृकसृष्टिवर्णनम्]  नैवेह किञ्चनाग्र आसीत् । मृत्युनैवेदमावृतमासीदशनायया । अशनाया हि मृत्युः। तन्मनोऽकुरुत आत्मन्वी स्यामिति । सोऽर्चनचरत् । तस्यार्चत आपोऽजायन्त । अर्चते वै मे कमभूदिति । तदेवार्कस्यार्कत्वम् । कँ ह वा अस्मै भवति, य एवमेतदर्कस्यात्वं वेद ॥ १ ॥  **
"""
        with open(
            os.path.join(self.test_input_dir, "03-01.md"), "w", encoding="utf-8"
        ) as f:
            f.write(self.sample_03_01_content)

        # Sample content for 03-02.md (simplified for test)
        self.sample_03_02_content = """+++ 
title = "०३-०२"

+++ 
**प्र. - अण्डस्य भगवदात्मकभूतपरिणामत्वं वक्तुम् अपां भगवदात्मकत्वमाह -** आपो वा अर्क इति । **आपः** - अर्कशब्दित भगवदात्मिका इत्यर्थः । **तद्यदपां शर आसीत्** इति । दध्नोमण्डांश इव भूतान्तरसंसृष्टानामपां यः **शरः** - सारांश आसीत, **तत् समहन्यत** - बाह्येन तेजसा पच्यमानं सत् सङ्घातभावमापद्यत । **सा पृथिव्यभवत्** - तत इति शेषः । **ततः** - संहन्यमानेभ्यो भूतेभ्यः **सा पृथिवी** - अण्डरूपा **पृथिव्यभवत्** । ता - आपः तद्धिरण्मयमण्डमभवत् (महो.१-४) इति महोपनिषदैकार्यात् । **तस्यामश्राम्यत्** 

इति । **तस्य** - परमात्मनः **श्रान्तस्य तप्तस्य तेजोरसो निरवर्तताग्निः** इति। **तस्य** -परमात्मनः **श्रान्तस्य-** 

कृतयत्नस्य, **तप्तस्य** - सृज्यवर्गपर्यालोचनवतः शरीरात् तेजोरसः । तेजस्सारभूतोऽग्निः **निरवर्तत** । एवमेव व्यासार्यैरुक्तम् ॥ २ ॥ 
"""
        with open(
            os.path.join(self.test_input_dir, "03-02.md"), "w", encoding="utf-8"
        ) as f:
            f.write(self.sample_03_02_content)

    def tearDown(self):
        # Clean up test directories
        if os.path.exists(self.test_input_dir):
            shutil.rmtree(self.test_input_dir)
        if os.path.exists(self.test_output_dir):
            shutil.rmtree(self.test_output_dir)

        # Clean up original output directory if it was created by the script during testing
        if os.path.exists(self.original_output_dir):
            shutil.rmtree(self.original_output_dir)

    def _extract_text_for_hashing(self, markdown_content: str) -> str:
        """Helper to extract text from generated markdown for hash verification."""
        text_for_hashing = markdown_content
        text_for_hashing = re.sub(r"#+\s*Mantra\s+\d+\.\d+\.\d+", "", text_for_hashing)
        text_for_hashing = re.sub(r"#+\s*Prefatory Material", "", text_for_hashing)
        text_for_hashing = re.sub(r"#+\s*Commentary:.*", "", text_for_hashing)
        text_for_hashing = re.sub(r"<!--.*?-->", "", text_for_hashing, flags=re.DOTALL)
        text_for_hashing = re.sub(
            r"\[.*?\]", "", text_for_hashing
        )  # Remove [section titles]
        text_for_hashing = re.sub(
            r"॥\s*इति.*?॥", "", text_for_hashing
        )  # Remove "इति" markers
        text_for_hashing = re.sub(r"प्र\.\s*-", "", text_for_hashing)  # Remove "प्र. -"
        return text_for_hashing

    def test_convert_03_01_md(self):
        input_file = os.path.join(self.test_input_dir, "03-01.md")
        output_file_path = convert_file(input_file, self.test_output_dir)

        self.assertTrue(output_file_path is not None)
        output_file_path = str(output_file_path)
        self.assertTrue(os.path.exists(output_file_path))

        with open(output_file_path, "r", encoding="utf-8") as f:
            content = f.read()

        # Verify YAML frontmatter
        frontmatter_match = re.match(r"^---\n(.*?)\n---", content, re.DOTALL)
        self.assertIsNotNone(frontmatter_match)
        frontmatter = yaml.safe_load(frontmatter_match.group(1))

        self.assertEqual(frontmatter["grantha_id"], "brihadaranyaka-upanishad")
        self.assertEqual(frontmatter["part_num"], 3)
        self.assertEqual(frontmatter["canonical_title"], "बृहदारण्यकोपनिषत्")
        self.assertEqual(frontmatter["scripts"], ["devanagari"])
        self.assertIn("validation_hash", frontmatter)

        # Verify structure_levels
        self.assertEqual(len(frontmatter["structure_levels"]), 1)
        self.assertEqual(frontmatter["structure_levels"][0]["key"], "3")
        self.assertEqual(
            frontmatter["structure_levels"][0]["scriptNames"]["devanagari"],
            "तृतीयोऽध्यायः",
        )
        self.assertEqual(len(frontmatter["structure_levels"][0]["children"]), 1)
        self.assertEqual(frontmatter["structure_levels"][0]["children"][0]["key"], "1")
        self.assertEqual(
            frontmatter["structure_levels"][0]["children"][0]["scriptNames"][
                "devanagari"
            ],
            "प्रथमं ब्राह्मणम्",
        )

        # Verify body content
        body = content[frontmatter_match.end() :].strip()
        self.assertIn("# Prefatory Material", body)
        self.assertIn("## उपक्रमशान्तिपाठः", body)
        self.assertIn("<!-- sanskrit:devanagari -->", body)
        self.assertIn("# Mantra 3.1.1", body)
        self.assertIn("## Commentary: रङ्गरामानुजमुनिः", body)
        self.assertIn(
            '<!-- commentary: {"commentary_id": "rangaramanuja", "passage_ref": "1"} -->',
            body,
        )
        self.assertIn("## [अश्चानुबन्धिषु दृष्टिः]", body)  # Check for section title in body
        self.assertIn("# Mantra 3.1.2", body)
        self.assertIn("## Commentary: रङ्गरामानुजमुनिः", body)
        self.assertIn(
            "## [अश्वमेधादौ दृष्टिविधानाय मृत्युकर्तृकसृष्टिवर्णनम्]", body
        )  # Check for section title in body
        self.assertIn(
            "# Mantra 3.1.1", body
        )  # This is the first mantra of the next Brahmana, but it's still part of the same file.
        # The script currently processes each file as a whole, so the mantra numbering resets per file.
        # This needs to be clarified: should mantra numbering be continuous across brahmanas within a part?
        # For now, I'll assume it's per file, as the current script does.

        # Verify hash
        extracted_text = self._extract_text_for_hashing(body)
        calculated_hash = f"sha256:{hash_text(extracted_text)}"
        self.assertEqual(frontmatter["validation_hash"], calculated_hash)

    def test_convert_03_02_md(self):
        input_file = os.path.join(self.test_input_dir, "03-02.md")
        output_file_path = convert_file(input_file, self.test_output_dir)

        self.assertTrue(output_file_path is not None)
        output_file_path = str(output_file_path)
        self.assertTrue(os.path.exists(output_file_path))
        self.assertTrue(os.path.exists(output_file_path))

        with open(output_file_path, "r", encoding="utf-8") as f:
            content = f.read()

        frontmatter_match = re.match(r"^---\n(.*?)\n---", content, re.DOTALL)
        self.assertIsNotNone(frontmatter_match)
        frontmatter = yaml.safe_load(frontmatter_match.group(1))

        self.assertEqual(frontmatter["part_num"], 3)
        self.assertEqual(frontmatter["structure_levels"][0]["children"][0]["key"], "2")
        self.assertEqual(
            frontmatter["structure_levels"][0]["children"][0]["scriptNames"][
                "devanagari"
            ],
            "द्वितीयं ब्राह्मणम्",
        )

        body = content[frontmatter_match.end() :].strip()
        self.assertIn(
            "# Mantra 3.2.2", body
        )  # The sample 03-02.md starts with mantra 2
        self.assertIn("## Commentary: रङ्गरामानुजमुनिः", body)
        self.assertIn(
            '<!-- commentary: {"commentary_id": "rangaramanuja", "passage_ref": "2"} -->',
            body,
        )

        # Verify hash
        extracted_text = self._extract_text_for_hashing(body)
        calculated_hash = f"sha256:{hash_text(extracted_text)}"
        self.assertEqual(frontmatter["validation_hash"], calculated_hash)

    def test_num_to_devanagari(self):
        self.assertEqual(num_to_devanagari(1), "१")
        self.assertEqual(num_to_devanagari(10), "१०")
        self.assertEqual(num_to_devanagari(3), "३")


if __name__ == "__main__":
    unittest.main()
